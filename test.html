<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script>
function componentToHex(c) {
    var hex = c.toString(16);
    return hex.length == 1 ? "0" + hex : hex;
}

function rgbToHex(r, g, b) {
    return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
}
var maxwidth = 0;
var machinesPositions = [];
var selectedOpeningRange = 1;
var startDate = new Date(2017,6,1,0,0);
var tableRowHeight = 0;
var ticketIdPrefix = "ticket";
var openingRanges = [{duration:12 * 60,interval:1},{duration:24 * 60,interval:1},{duration:2 * 24 * 60,interval:4},{duration:7 * 24 * 60,interval:12},{duration:14 * 24 * 60,interval:24},{duration:30 * 24 * 60,interval:24},{duration:60 * 24 * 60,interval:48}];
var machines = [];
var tickets = [];
function loadData(){
   machines = [{id:"SM234",name:"Speed 234"},{id:"SM115",name:"Speed 115"},{id:"MR23",name:"MAN 23"}];
   
   tickets = [{id:123,title:"t1",machine:"SM234",start:new Date(2017,6,1,2,0),duration:60,color:"#73AD21"},
              {id:125,title:"t2",machine:"SM234",start:new Date(2017,6,1,3,10),duration:180,color:"red"},
              {id:234,title:"t2",machine:"SM115",start:new Date(2017,6,1,4,0),duration:240,color:"#000021"},
              {id:12,machine:"SM115",start:new Date(2017,6,1,0,0),duration:120,closing:1}];
/*
for (var i=1;i<2000;i++){
   var duration= Math.random()*150+50;
   var start= new Date(2017,Math.trunc(Math.random()*11),Math.trunc(Math.random()*30),0,0);
   var machineIndex =Math.trunc(Math.random()*3);
   tickets.push({id:i+1000,title:"t1",machine:machines[machineIndex].id,start:start,duration:duration,color:rgbToHex(Math.round(Math.random()*256), Math.round(Math.random()*256), Math.round(Math.random()*256))})
}*/
   
}
function setMachines(){
   $.each( machines, function( key, machine ) {
           machinesPositions.push(machine.id);
        });
}
$(document).ready(function(){
    tableRowHeight = $(".machineRow").height();
    function offsetStartDate(stringDate){
        startDate = new Date(stringDate);
        startDate.setHours(startDate.getHours()-openingRanges[selectedOpeningRange].duration/(2*60));
        updateTimeLine();
        resizeTickets();
    }
    function resizeTicket(ticket){
        $("div#ticket"+ticket.id).width(ticket.duration*maxwidth/openingRanges[selectedOpeningRange].duration);
        var machineLine = $.inArray(ticket.machine,machinesPositions);
        $("div#ticket"+ticket.id).css({left: dateToPosition(ticket.start),top:machineLine*tableRowHeight+$("#ticketsTable>thead").height()});
    }
    function resizeWindows(){
        $("#scheduling-area").width($(window).width()-20);//$(document).width() devient faux quand il y a beacoup de tickets
        maxwidth = $("#scheduling-area").width();
        $("#timeLineDiv").width(maxwidth);
        resizeColumns();
        resizeTickets();
    }
    function resizeTickets(){
        $.each( tickets, function( key, ticket ) {
           resizeTicket(ticket);
        });
    }
    function resetColumns(){
        $(".machineRow").empty();
        $("#timeLineRow1").empty();
        var columnsNb = openingRanges[selectedOpeningRange].duration / (openingRanges[selectedOpeningRange].interval * 60);
        for (var i =0; i < columnsNb; i++) {
        var cell = $("<td></td>");
        var headCell = $("<td>12</td>");
        cell.addClass("cell");
        headCell.addClass("cell");
        headCell.addClass("timeLineCell");
        $(".machineRow").append(cell);
        $("#timeLineRow1").append(headCell);
        }
    }
    
    function updateTimeLine(){
        var interval = openingRanges[selectedOpeningRange].interval;
        var date = new Date(startDate);
        if (interval<24){
            $("#timeLineRow1 > td").each(function(td){
               var hour = date.getHours();
               $(this).text(hour<10?"0"+hour+":00":hour+":00");
               $(this).attr("datestring",date.toString());
               date.setHours(date.getHours() + interval);
            });
        }else{
            $("#timeLineRow1 > td").each(function(td){
               $(this).text(date.getDate()+"/"+(date.getMonth()+1));
               $(this).attr("datestring",date.toString());
               date.setDate(date.getDate() + interval/24);
            });
        }
        $(".timeLineCell").off("click").click(function(){
            offsetStartDate($(this).attr("datestring"));
        });
    }
    function resizeColumns(){
        var cellwidth = Math.round(maxwidth / $("#ticketsTable").find("tr:first td").length);
        $(".cell").width(cellwidth);
    }
    function changeOpeningRange(){
        resetColumns();
        resizeColumns();
        updateTimeLine();
    }

    resetColumns();
    resizeWindows();
    updateTimeLine();

    $(window).resize(function(){
        resizeWindows();
    });


    function createTicketElement(ticket){
        var ticketElement = $("<div></div>");
        ticketElement.text(ticket.title);
        ticketElement.attr("title","");//pour faire apparaitre le tooltip
        ticketElement.addClass("ticket");
        ticketElement.attr("id", ticketIdPrefix+ticket.id);
        ticketElement.css({"background-color":ticket.color||"lightgray","vertical-align":"center","text-align": "center"});
        $("#scheduling-area").append(ticketElement);
        if (!ticket.closing) {
        ticketElement.draggable({
           revert : "invalid",
           start : function(event,ui){
              $(".ticket").css({zIndex:1});
              ui.helper.css({zIndex:2});
           }
           });//draggable doit etre defini après avoir placé le ticket dans le dom
        }
        /*ticketElement.tooltip({
              content: "<div><p>"+ticket.title+"</p><p>"+ticket.duration+"</p></div>"
        });*/
        //ticketElement.tooltip( "option", "content", "<div><p>"+ticket.title+"</p><p>"+ticket.duration+"</p></div>" );
        return ticketElement;
    }
$("button#start").click(function(){
    loadData();
    setMachines();
    $.each( tickets, function( key, ticket ) {
        var ticketElement = createTicketElement(ticket);
        resizeTicket(ticket);
    });
});
$("button#zoomin").click(function(){
    if (selectedOpeningRange===0)
       return;
    selectedOpeningRange--;
    resizeTickets();
    changeOpeningRange();
});
$("button#zoomout").click(function(){
    if (selectedOpeningRange>=openingRanges.length-1)
       return;
    selectedOpeningRange++;
    resizeTickets();
    changeOpeningRange();
});
$("#scheduling-area").droppable({
    drop : function(event,ui){
        var ticketId = eval(ui.draggable.attr("id").substring(ticketIdPrefix.length));
        var currentMachineId = "";
        var minDelta = 100000;
        $.each(machines, function( key, machine ) {
           if (Math.abs(tableRowHeight*key-ui.position.top)<minDelta){
               minDelta = Math.abs(tableRowHeight*key-ui.position.top);
               currentMachineId = machine.id;
           }
        });
        $.each(tickets, function( key, ticket ) {
                   if (ticket.id === ticketId){
                       ticket.machine =  currentMachineId;
                       ticket.start =  positionToDate(ui.position.left);
                       resizeTicket(ticket);
                       return;
                   }
        });
    }

});
function dateToPosition(date){
    var elapseMin = (date.getTime() - startDate.getTime()) / (1000 * 60);
    return elapseMin*maxwidth/openingRanges[selectedOpeningRange].duration;
}
function positionToDate(position){
    var minFromStart=position*openingRanges[selectedOpeningRange].duration/maxwidth;
    return new Date(startDate.getTime() + minFromStart*60000);
}

});
</script>
<style>
body {
    background-color:white;
    font-family:arial;
} 
.machineRow{
    height:70px
}
.cell{
    border: 1px solid lightgray;
    font-size:12px;
    color:darkgray;
    text-align:center;
}
#timeLineRow1 {
    height: 20px
}
table {
    border-collapse: collapse;
    border: 1px solid lightgray;
}
div.ticket {
    position: absolute;
    display: inline-block;
    top: 0;
    left: 0;
    width: 0;
    height: 70px;
}
#scheduling-area {
    position: relative;
}

</style>
</head>
<body>
    <p>hello world !</p>
    <button id="start">start</button>
    <button id="modify">modify</button>
    <button id="zoomin">+</button>
    <button id="zoomout">-</button>
    
    <div id="scheduling-area">
    <table id="ticketsTable"> 
        <thead>
  <tr id="timeLineRow1">
  </tr>
 </thead>
    <tbody>
        <tr class="machineRow">
        </tr>
        <tr class="machineRow">
        </tr>
        <tr class="machineRow">
        </tr>
 </tbody>
    </table>
    </div>
    
</body>
</html>