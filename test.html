<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script>
var openingRange = 24 * 60;
var selectedOpeningRange = 1;
var startDate = new Date(2017,6,1,0,0);
var tableRowHeight = 70;
var ticketIdPrefix = "ticket";
var openingRanges = [{duration:12 * 60,interval:1},{duration:24 * 60,interval:1},{duration:2 * 24 * 60,interval:8},{duration:7 * 24 * 60,interval:12},{duration:14 * 24 * 60,interval:24},{duration:30 * 24 * 60,interval:24}];
var machines = [{id:"SM234",name:"Speed 234"},{id:"SM115",name:"Speed 115"},{id:"MR23",name:"MAN 23"}];
var tickets = [{id:123,title:"t1",machine:"SM234",start:new Date(2017,6,1,2,0),duration:60,color:"#73AD21"},
{id:125,title:"t2",machine:"SM234",start:new Date(2017,6,1,3,10),duration:180,color:"red"},
{id:234,title:"t2",machine:"SM115",start:new Date(2017,6,1,4,0),duration:240,color:"#000021"},
{id:12,machine:"SM115",start:new Date(2017,6,1,0,0),duration:120,closing:1}];
/*for (var i=1;i<1000;i++){
   var duration= Math.random()*150+50;
   var start= Math.random()*2000-1000;
   tickets.push({id:i+1000,title:"t1",machine:"SM234",start:start,duration:duration,color:"#73AD21"})
}*/
$(document).ready(function(){
    var maxwidth = 0;
    var machinesPositions = [];
    $.each( machines, function( key, machine ) {
           machinesPositions.push(machine.id);
        });
    function resizeTicket(ticket){
        $("div#ticket"+ticket.id).width(ticket.duration*maxwidth/openingRange);
        var machineLine = $.inArray(ticket.machine,machinesPositions);
        $("div#ticket"+ticket.id).css({left: dateToPosition(ticket.start)/*ticket.start*maxwidth/openingRange*/,top:machineLine*tableRowHeight});
    }
    function resizeWindows(){
        $("#scheduling-area").width($(document).width()-20);
        maxwidth = $("#scheduling-area").width();
        resizeColumns();
        resizeTickets();
    }
    function resizeTickets(){
        $.each( tickets, function( key, ticket ) {
           resizeTicket(ticket);
        });
    }
    function resetColumns(){
        $(".machineRow").empty();
        var nb = openingRange / (openingRanges[selectedOpeningRange].interval * 60);
        for (var i =0; i < nb; i++) {
        var cell = $("<td></td>");
        cell.addClass("cell");
        $(".machineRow").append(cell);
        }
    }
    function resizeColumns(){
        var cellwidth = maxwidth / $("table").find("tr:first td").length;
        $(".cell").width(cellwidth);
    }
    function changeOpeningRange(){
        resetColumns();
        resizeColumns();
    }

    resetColumns();
    resizeWindows();
    
    $(window).resize(function() {
        resizeWindows();
    });

    function createTicketElement(ticket){
        var ticketElement = $("<div></div>");
        ticketElement.text(ticket.title);
        ticketElement.attr("title","");//pour faire apparaitre le tooltip
        ticketElement.addClass("ticket");
        ticketElement.attr("id", ticketIdPrefix+ticket.id);
        ticketElement.css({"background-color":ticket.color||"lightgray","vertical-align":"center","text-align": "center"});
        $("#scheduling-area").append(ticketElement);
        if (!ticket.closing) {
        ticketElement.draggable({
           revert : "invalid",
           start : function(event,ui){
              $(".ticket").css({zIndex:1});
              ui.helper.css({zIndex:2});
           }
           });//draggable doit etre defini après avoir placé le ticket dans le dom
        }
        /*ticketElement.tooltip({
              content: "<div><p>"+ticket.title+"</p><p>"+ticket.duration+"</p></div>"
        });*/
        //ticketElement.tooltip( "option", "content", "<div><p>"+ticket.title+"</p><p>"+ticket.duration+"</p></div>" );
        return ticketElement;
    }
$("button#start").click(function(){
    $.each( tickets, function( key, ticket ) {
        var ticketElement = createTicketElement(ticket);
        resizeTicket(ticket);
    });
});
$("button#modify").click(function(){
    openingRange = 24 * 60 * 2;
    startDate = new Date(2017,5,30,0,0);
    resizeTickets();
});
$("button#zoomin").click(function(){
    if (selectedOpeningRange===0)
       return;
    selectedOpeningRange--;
    openingRange = openingRanges[selectedOpeningRange].duration;
    resizeTickets();
    changeOpeningRange();
});
$("button#zoomout").click(function(){
    if (selectedOpeningRange>=openingRanges.length-1)
       return;
    selectedOpeningRange++;
    openingRange = openingRanges[selectedOpeningRange].duration;
    resizeTickets();
    changeOpeningRange();
});
$("#scheduling-area").droppable({
    drop : function(event,ui){
        var ticketId = eval(ui.draggable.attr("id").substring(ticketIdPrefix.length));
        var currentMachineId = "";
        var minDelta = 100000;
        $.each(machines, function( key, machine ) {
           if (Math.abs(tableRowHeight*key-ui.position.top)<minDelta){
               minDelta = Math.abs(tableRowHeight*key-ui.position.top);
               currentMachineId = machine.id;
           }
        });
        //alert(ticketId+" "+ui.position.top+"/"+ui.position.left);
        $.each(tickets, function( key, ticket ) {
                   if (ticket.id === ticketId){
                       ticket.machine =  currentMachineId;
                       ticket.start =  positionToDate(ui.position.left);//*openingRange/maxwidth;
                       resizeTicket(ticket);
                       return;
                   }
        });
    }

});
   //$("#scheduling-area").on("drop", function( event, ui ) {alert(ui)} );
function dateToPosition(date){
    var elapseMin = (date.getTime() - startDate.getTime()) / (1000 * 60);
    return elapseMin*maxwidth/openingRange;
}
function positionToDate(position){
    var minFromStart=position*openingRange/maxwidth;
    return new Date(startDate.getTime() + minFromStart*60000);
}
});
</script>
<style>
body {
    background-color:white;
} 
.machineRow{
    height:70px
}
.cell{
    border: 1px solid lightgray;
}
table {
    border-collapse: collapse;
    border: 1px solid lightgray;
}
div.ticket {
    position: absolute;
    display: inline-block;
    top: 0;
    left: 0;
    width: 0;
    height: 70px;
}
#scheduling-area {
    position: relative;
}
</style>
</head>
<body>
    <p>hello world !</p>
    <button id="start">start</button>
    <button id="modify">modify</button>
    <button id="zoomin">+</button>
    <button id="zoomout">-</button>
    <div id="scheduling-area">
    <table>
        <tr class="machineRow">
        </tr>
        <tr class="machineRow">
        </tr>
        <tr class="machineRow">
        </tr>
    </table>
    
    </div>
</body>
</html>